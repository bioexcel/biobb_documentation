# Execution

## Execution in command line

### Binary path configuration

First off, we recommend to configure binary paths in your environment in order to easy the command line execution. For doing that, please follow the next steps:

#### Create binary folder

Remember to change the */home/user_name/projects/* path to the real path on your computer.

```Shell
mkdir /home/user_name/projects/bin
```

#### Change python file permissions

Remember to change the */home/user_name/projects/* path to the real path on your computer.

```Shell
chmod +x /home/user_name/projects/biobb_template/biobb_template/template/template.py
```

#### Create symlink to python file

Remember to change the */home/user_name/projects/* path to the real path on your computer.

```Shell
cd /home/user_name/projects/bin
ln -s /home/user_name/projects/biobb_template/biobb_template/template/template.py template
```

#### Create conda activate actions

Remember to change the */[anaconda-path]* and the */home/user_name/projects/* path to the real paths on your computer.

```Shell
cd /[anaconda-path]/envs/biobb_template/etc
mkdir conda
cd conda/
mkdir activate.d
cd activate.d/
printf '#!/usr/bin/env bash\n\nexport BIOBB_OLD_PATH=$PATH\nexport PATH=/home/user_name/projects/bin:$PATH' > biobb_template.sh
```

#### Create conda deactivate actions

Remember to change the */[anaconda-path]* and the */home/user_name/projects/* path to the real paths on your computer.

```Shell
cd /[anaconda-path]/envs/biobb_template/etc/conda
mkdir deactivate.d
cd deactivate.d/
printf '#!/usr/bin/env bash\n\nexport PATH=$BIOBB_OLD_PATH' > biobb_template.sh
```

#### Restart environment

```Shell
conda deactivate
conda activate biobb_template
```

### Execution

All the information about the command line execution of a **BioBB** can be found here:

[https://biobb-template.readthedocs.io/en/latest/command_line.html](https://biobb-template.readthedocs.io/en/latest/command_line.html)

## Execution in Jupyter Notebook

**Jupyter Notebook** (formerly IPython Notebooks) is a web-based interactive computational environment for creating [Jupyter](https://jupyter.org/) notebook documents. The *notebook* term can colloquially make reference to many different entities, mainly the Jupyter web application, Jupyter Python web server, or Jupyter document format depending on context. A **Jupyter Notebook** document is a JSON document, following a versioned schema, and containing an ordered list of **input/output cells** which can contain code, text (using Markdown), mathematics, plots and rich media, usually ending with the ".ipynb" extension.

A Jupyter Notebook can be converted to a number of open standard output formats (**HTML**, **presentation slides**, **LaTeX**, **PDF**, **ReStructuredText**, **Markdown**, **Python**) through *Download As* in the web interface, via the nbconvert library or *jupyter nbconvert* command line interface in a shell.

To simplify visualisation of **Jupyter Notebook** documents on the web, the nbconvert library is provided as a service through NbViewer which can take a URL to any publicly available notebook document, convert it to **HTML on the fly** and display it to the user.

Basic examples of **Jupyter Notebook** execution for *biobb_template* can be found here:

[https://github.com/bioexcel/biobb_template/blob/master/biobb_template/notebooks/template/template.ipynb](https://github.com/bioexcel/biobb_template/blob/master/biobb_template/notebooks/template/template.ipynb)

The execution is pretty straightforward: 

1. We must **create an object** with the tool **properties** in case the properties are mandatory for this tool. More information about the properties [clicking here](https://biobb-documentation.readthedocs.io/en/latest/arguments.html#properties).

2. We call the **tool class** with the mandatory **inputs** / **outputs** and the **properties** defined in the previous step.


```python
prop = {
    "boolean_property": False,
    "remove_tmp": True
}
Template(input_file_path1=input1, 
         input_file_path2=input2, 
         output_file_path=output, 
         properties=prop).launch()
```

After executing this cell in **Jupyter Notebook** we will get the output log generated by the tool. In the example above, it should be something like this:


```python
2020-02-20 17:34:14,566 [MainThread  ] [INFO ]  Creating 19838984-a76c-401e-9226-4a814268391c temporary folder
2020-02-20 17:34:14,587 [MainThread  ] [INFO ]  Creating command line with instructions and required arguments
2020-02-20 17:34:14,597 [MainThread  ] [INFO ]  Appending optional argument to command line
2020-02-20 17:34:15,173 [MainThread  ] [INFO ]  zip -j output 19838984-a76c-401e-9226-4a814268391c/input1 19838984-a76c-401e-9226-4a814268391c/input2

2020-02-20 17:34:15,178 [MainThread  ] [INFO ]  Exit code 0

2020-02-20 17:34:15,181 [MainThread  ] [INFO ]    adding: input1 (deflated 87%)
  adding: input2 (deflated 14%)

2020-02-20 17:34:15,191 [MainThread  ] [INFO ]  Removed: 19838984-a76c-401e-9226-4a814268391c
```

## Unittests

In computer programming, **unit testing** is a software testing method by which individual units of source code, sets of one or more computer program modules together with associated control data, usage procedures, and operating procedures, are **tested** to determine whether they are fit for use.

The **BioBB unittests** are performed using [Nose](https://nose.readthedocs.io/en/latest/index.html), that comes installed in the conda environment generated in the *biobb_template*.

### Files structure

[https://github.com/bioexcel/biobb_template/tree/master/biobb_template/test](https://github.com/bioexcel/biobb_template/tree/master/biobb_template/test)

Opening the *test* folder in *biobb_template* shows us the next files structure:

* data/
    * config/
        * config_template.json
        * config_template_container.json
    * template/
        * topology.top
        * trajectory.dcd
* reference/
    * template/
        * output_container.zip
        * output.zip
* unitests/
    * test_template/
        * test_template.py
        * test_template_container.py
* \_\_init\_\_.py
* conf.yml

#### data folder

[https://github.com/bioexcel/biobb_template/tree/master/biobb_template/test/data](https://github.com/bioexcel/biobb_template/tree/master/biobb_template/test/data)

In this folder we find two subfolders:

##### config folder

[https://github.com/bioexcel/biobb_template/tree/master/biobb_template/test/data/config](https://github.com/bioexcel/biobb_template/tree/master/biobb_template/test/data/config)

These config **JSON files** are automatically generated as explained in the [JSON Schemas section](https://biobb-documentation.readthedocs.io/en/latest/schemas.html#tools-json-schemas). Its utility is mainly for the [BioBB REST API](https://mmb.irbbarcelona.org/biobb-api/) purposes. They are generated after parsing the *conf.yml* file explained below in this same section.

Example of [config_template.json](https://github.com/bioexcel/biobb_template/blob/master/biobb_template/test/data/config/config_template.json):


```python
{
    "properties": {
        "boolean_property": false,
        "remove_tmp": true
    }
}
```

##### template folder

[https://github.com/bioexcel/biobb_template/tree/master/biobb_template/test/data/template](https://github.com/bioexcel/biobb_template/tree/master/biobb_template/test/data/template)

In this folder we find the two input files needed for the execution of the two tools (Template and TemplateContainer).

#### reference folder

[https://github.com/bioexcel/biobb_template/tree/master/biobb_template/test/reference](https://github.com/bioexcel/biobb_template/tree/master/biobb_template/test/reference)

##### template folder

[https://github.com/bioexcel/biobb_template/tree/master/biobb_template/test/reference/template](https://github.com/bioexcel/biobb_template/tree/master/biobb_template/test/reference/template)

In this folder we find the two input files generated as a result of the execution of the two tools (Template and TemplateContainer).

#### unitests folder

[https://github.com/bioexcel/biobb_template/tree/master/biobb_template/test/unitests](https://github.com/bioexcel/biobb_template/tree/master/biobb_template/test/unitests)

##### test_template folder

[https://github.com/bioexcel/biobb_template/tree/master/biobb_template/test/unitests/test_template](https://github.com/bioexcel/biobb_template/tree/master/biobb_template/test/unitests/test_template)

In this folder we find the two Python files used for the test execution. They parse the *conf.yml* file explained below and execute the unittest.

Example of [test_template.py](https://github.com/bioexcel/biobb_template/blob/master/biobb_template/test/unitests/test_template/test_template.py), that performs the unittest for the [template.py](https://github.com/bioexcel/biobb_template/blob/master/biobb_template/template/template.py) code:


```python
from biobb_common.tools import test_fixtures as fx
from biobb_template.template.template import Template

class TestTemplate():
    def setUp(self):
        fx.test_setup(self, 'template')

    def tearDown(self):
        fx.test_teardown(self)
        pass

    def test_template(self):
        returncode= Template(properties=self.properties, **self.paths).launch()
        assert fx.not_empty(self.paths['output_file_path'])
        assert fx.equal(self.paths['output_file_path'], self.paths['ref_output_file_path'])
        assert fx.exe_success(returncode)
```

Example of [test_template_container.py](https://github.com/bioexcel/biobb_template/blob/master/biobb_template/template/template_container.py), that performs the unittest for the [template_container.py](https://github.com/bioexcel/biobb_template/blob/master/biobb_template/template/template_container.py) code, in this case one test for **docker container** and another for **singularity container**:


```python
from biobb_common.tools import test_fixtures as fx
from biobb_template.template.template_container import TemplateContainer

class TestTemplateDocker():
    def setUp(self):
        fx.test_setup(self, 'template_container')

    def tearDown(self):
        fx.test_teardown(self)
        pass

    def test_template_docker(self):
        returncode= TemplateContainer(properties=self.properties, **self.paths).launch()
        assert fx.not_empty(self.paths['output_file_path'])
        assert fx.equal(self.paths['output_file_path'], self.paths['ref_output_file_path'])
        assert fx.exe_success(returncode)

class TestTemplateSingularity():
    def setUp(self):
        fx.test_setup(self, 'template_singularity')

    def tearDown(self):
        fx.test_teardown(self)
        pass

    def test_template_singularity(self):
        returncode= TemplateContainer(properties=self.properties, **self.paths).launch()
        assert fx.not_empty(self.paths['output_file_path'])
        assert fx.equal(self.paths['output_file_path'], self.paths['ref_output_file_path'])
        assert fx.exe_success(returncode)
```

#### conf.yml

**YAML** file with all the paths and properties for **unittests**. For each test we must define:

* paths
    * input paths: paths to the files defined in the *test/data/template* folder.
    * output paths: name for the file that will be generated after the execution, usuarlly in the */tmp* folder.
    * reference output paths: paths to the files defined in the *test/reference/template* folder.
* properties

The *biobb_template* [conf.yml](https://github.com/bioexcel/biobb_template/blob/master/biobb_template/test/conf.yml) file:

```yml
working_dir_path: /tmp/biobb/unitests

template:
  paths:
    input_file_path1: file:test_data_dir/template/topology.top
    input_file_path2: file:test_data_dir/template/trajectory.dcd
    output_file_path: output.zip
    ref_output_file_path: file:test_reference_dir/template/output.zip
  properties:
    boolean_property: false
    remove_tmp: true

template_container:
  paths:
    input_file_path1: file:test_data_dir/template/topology.top
    input_file_path2: file:test_data_dir/template/trajectory.dcd
    output_file_path: output.zip
    ref_output_file_path: file:test_reference_dir/template/output.container.zip
  properties:
    boolean_property: false
    remove_tmp: true
    container_path: docker
    container_image: mmbirb/zip:latest
    container_volume_path: /tmp

template_singularity:
  paths:
    input_file_path1: file:test_data_dir/template/topology.top
    input_file_path2: file:test_data_dir/template/trajectory.dcd
    output_file_path: output.zip
    ref_output_file_path: file:test_reference_dir/template/output.container.zip
  properties:
    boolean_property: false
    remove_tmp: true
    executable_binary_property: /opt/conda/bin/zip
    container_path: singularity
    container_image: bioexcel-zip_container-master-latest.simg
    container_volume_path: /tmp
```

### Unittests execution

Finally, in order to execute the unittests, you only need to call the Python test files:

#### Template

```Shell
nosetests -s biobb_template/biobb_template/test/unitests/test_template/test_template.py
```

#### Template Container

```Shell
nosetests -s biobb_template/biobb_template/test/unitests/test_template/test_template_container.py
```
